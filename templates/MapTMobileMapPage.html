<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapTech</title>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:"Roboto", sans-serif; }
    #header {
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      padding:10px;
      position:fixed;
      top:0;
      width:100%;
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:flex-start;
    }
    .header-title { font-size:18px; }
    #mapMenu {
      background:#fff;
      border-bottom:1px solid #dcdcdc;
      position:fixed;
      top:50px;
      left:0;
      width:100%;
      height:30px;
      overflow:hidden;
      transition:height 0.3s;
      z-index:999;
    }
    #mapMenu.expanded { height:150px; }
    #mapMenuHeader { display:flex; align-items:center; padding:0 10px; height:30px; cursor:pointer; }
    #mapMenuContent { display:none; padding:10px; }
    #mapMenu.expanded #mapMenuContent { display:block; }
    .menu-buttons { display:flex; flex-wrap:wrap; gap:10px; }
    .mapTButton { padding:5px 10px; background:#eee; border-radius:4px; text-decoration:none; color:#333; }
    #map {
      width:100%;
      height:calc(100% - 50px);
      margin-top:50px;
    }
    /* Detail side panel */
    #detailOverlay {
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:0;
      overflow:hidden;
      background:rgba(0,0,0,0.25);
      transition:width 0.3s ease;
      z-index:1300;
    }
    #detailPanel {
      position:absolute;
      top:0;
      right:-480px;
      width:480px;
      height:100%;
      background:#fff;
      box-shadow:-2px 0 8px rgba(0,0,0,0.15);
      transition:right 0.3s ease;
      display:flex;
      flex-direction:column;
      padding:12px;
      box-sizing:border-box;
      overflow-y:auto;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    #detailOverlay.open { width:100%; }
    #detailOverlay.open #detailPanel { right:0; }
    .detail-panel-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .detail-title {
      font-size:16px;
      font-weight:bold;
      color:#5a8a1f;
    }
    .detail-close {
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
    }
    .detail-btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .detail-ghost-btn {
      padding:8px 14px;
      border:1px solid #d1d5db;
      border-radius:6px;
      background:#f7f7f7;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.9);
      cursor:default;
    }
    .detail-section {
      border:1px solid #e5e7eb;
      margin-bottom:12px;
      border-radius:4px;
      overflow:hidden;
    }
    .detail-section-title {
      background:#f9fafb;
      padding:8px 10px;
      font-weight:bold;
      border-bottom:1px solid #e5e7eb;
    }
    .detail-table { width:100%; border-collapse:collapse; }
    .detail-table td {
      border-top:1px solid #e5e7eb;
      padding:8px;
      font-size:13px;
    }
    .detail-table td.label {
      background:#f5f5f5;
      width:28%;
      font-weight:bold;
    }
    .info-btn {
      padding:6px 12px;
      border:1px solid #d8c7a7;
      background:#f2e4cf;
      border-radius:4px;
      font-size:12px;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.8);
    }
    /* Search side panel (compact) */
    #searchOverlay {
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:0;
      overflow:hidden;
      background:rgba(0,0,0,0.25);
      transition:width 0.3s ease;
      z-index:1250;
    }
    #searchPanel {
      position:absolute;
      top:0;
      right:-340px;
      width:340px;
      height:100%;
      background:#fff;
      box-shadow:-2px 0 8px rgba(0,0,0,0.15);
      transition:right 0.3s ease;
      display:flex;
      flex-direction:column;
      padding:12px;
      box-sizing:border-box;
      overflow-y:auto;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    #searchOverlay.open { width:100%; }
    #searchOverlay.open #searchPanel { right:0; }
    .search-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .search-title { color:#6ea400; font-weight:bold; font-size:16px; }
    .search-close {
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
    }
    .search-item {
      border:1px solid #d1d5db;
      border-radius:6px;
      padding:10px 12px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .search-icon {
      width:24px;
      height:24px;
      border:2px solid #8c8c8c;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#8c8c8c;
      font-size:12px;
      box-sizing:border-box;
    }
    .search-label {
      font-size:13px;
      color:#333;
    }
    /* Modal for detail search */
    #searchModalOverlay {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1400;
    }
    #searchModal {
      background:#fff;
      width:80%;
      max-width:720px;
      max-height:80%;
      overflow:auto;
      border-radius:8px;
      box-shadow:0 6px 16px rgba(0,0,0,0.25);
      padding:16px;
      box-sizing:border-box;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    .search-modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .search-modal-title { font-size:16px; font-weight:bold; }
    .search-modal-close { background:none; border:none; font-size:20px; cursor:pointer; }
    .search-form {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
      gap:12px;
      margin-bottom:12px;
    }
    .search-field {
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
    }
    .search-field label { font-weight:bold; }
    .search-field input {
      padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:4px;
      font-size:12px;
    }
    .search-modal-actions {
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .search-modal-actions button {
      padding:8px 14px;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#f7f7f7;
      cursor:pointer;
    }
    .search-modal-actions .primary {
      background:#4caf50;
      color:#fff;
      border-color:#4caf50;
    }
  </style>
</head>
<body>
  <div id="header">
    <div class="header-title">MapTech 地図モバイル</div>
  </div>

  <div id="mapMenu" class="expanded">
    <div id="mapMenuHeader">
      <span id="hideLink">▼ メニュー</span>
      <span id="showLink" style="display:none;">▶ メニュー</span>
    </div>
    <div id="mapMenuContent">
      <div class="menu-buttons">
        <a href="#" class="mapTButton" onclick="openSetting()">ユーザ設定</a>
        <a href="#" class="mapTButton" onclick="searchRecords()">検索</a>
        <a href="#" class="mapTButton" onclick="showRoute()">ルート</a>
        <a href="#" class="mapTButton" onclick="registerLead()">登録モード</a>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div id="mapError" style="display:none; position:fixed; top:60px; left:10px; right:10px; padding:10px; background:#fff3cd; color:#664d03; border:1px solid #ffeeba; border-radius:4px; z-index:1200;">
    Googleマップを読み込めませんでした。APIキーが期限切れか権限不足の可能性があります。キーを再発行し、必要なAPIと課金・リファラー設定をご確認ください。
  </div>

  <div id="detailOverlay">
    <div id="detailPanel">
      <div class="detail-panel-header">
        <div class="detail-title">情報詳細</div>
        <button class="detail-close" onclick="hideDetailPanel()">×</button>
      </div>
      <div id="detailPanelBody"></div>
    </div>
  </div>

  <div id="searchOverlay">
    <div id="searchPanel">
      <div class="search-header">
        <div class="search-title">検索</div>
        <button class="search-close" onclick="hideSearchPanel()">×</button>
      </div>
      <div class="search-item" onclick="openDetailSearchModal()"><div class="search-icon">🔍</div><div class="search-label">詳細検索</div></div>
      <div class="search-item"><div class="search-icon">📝</div><div class="search-label">記録条件検索</div></div>
      <div class="search-item"><div class="search-icon">👤</div><div class="search-label">担当顧客</div></div>
      <div class="search-item"><div class="search-icon">📍</div><div class="search-label">担当エリア</div></div>
      <div class="search-item"><div class="search-icon">👥</div><div class="search-label">所属グループ</div></div>
    </div>
  </div>

  <div id="searchModalOverlay">
    <div id="searchModal">
      <div class="search-modal-header">
        <div class="search-modal-title">詳細検索</div>
        <button class="search-modal-close" onclick="closeDetailSearchModal()">×</button>
      </div>
      <div id="searchModalBody">
        <div style="padding:8px;">読み込み中...</div>
      </div>
      <div class="search-modal-actions">
        <button onclick="clearSearchForm()">検索条件クリア</button>
        <button class="primary" onclick="executeSearch()">検索実行</button>
        <button onclick="recordSearch()">検索条件の記録</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mapMenu = document.getElementById('mapMenu');
      const hideLink = document.getElementById('hideLink');
      const showLink = document.getElementById('showLink');
      window.customerIconUrl = "/static/Home/FFFFFF.png";

      hideLink.addEventListener('click', () => {
        mapMenu.classList.remove('expanded');
        hideLink.style.display = 'none';
        showLink.style.display = 'inline';
      });

      showLink.addEventListener('click', () => {
        mapMenu.classList.add('expanded');
        hideLink.style.display = 'inline';
        showLink.style.display = 'none';
      });
    });

    window.initMap = function () {
      const defaultPos = { lat: 35.681236, lng: 139.767125 };
      const map = new google.maps.Map(document.getElementById('map'), {
        center: defaultPos,
        zoom: 13,
        mapId: "{{ map_id }}"
      });
      window.map = map;
      const infoWindow = new google.maps.InfoWindow({ content: "" });
      window.infoWindow = infoWindow;
      window.__leadMarker = null;
      window.__leadPosition = null;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userPos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            const userMarker = new google.maps.marker.AdvancedMarkerElement({
              position: userPos,
              map,
              title: '現在地',
              zIndex: 10,
              content: buildCircleMarker('#0b7dda')
            });
            userMarker.addListener('click', () => infoWindow.open({ anchor: userMarker, map }));
            map.setCenter(userPos);
          },
          (error) => console.error('Geolocation error:', error)
        );
      }

      fetch('/api/markers')
        .then((res) => res.json())
        .then((data) => {
          renderCustomerMarkers(data);
        })
        .catch((err) => console.error('Markers fetch error:', err));
    };

    function openSetting() { alert('設定画面を開きます'); }
    function searchRecords() { showSearchPanel(); }
    function showRoute() { alert('ルート表示を実行します'); }
    function registerLead() { startRegisterMode(); }

    function buildMarkerContent(iconUrl, title) {
      const img = document.createElement('img');
      img.src = iconUrl;
      img.alt = title || 'marker';
      img.style.width = '36px';
      img.style.height = '36px';
      img.style.objectFit = 'contain';
      return img;
    }

    function renderCustomerMarkers(data) {
      const infoWindow = window.infoWindow;
      if (window.__customerMarkers && window.__customerMarkers.length) {
        window.__customerMarkers.forEach((mk) => (mk.map = null));
      }
      window.__customerMarkers = [];
      data.forEach((m) => {
        const marker = new google.maps.marker.AdvancedMarkerElement({
          position: { lat: m.lat, lng: m.lng },
          map: window.map,
          title: m.title,
          content: buildMarkerContent(window.customerIconUrl, m.title),
          zIndex: 100,
        });
        marker.addListener('click', () => {
          infoWindow.close();
          infoWindow.setContent(renderLoading());
          infoWindow.open({ anchor: marker, map: window.map });
          fetch(`/api/customers/${m.id}/detail`)
            .then((res) => {
              if (!res.ok) throw new Error(`Failed to load detail: ${res.status}`);
              return res.json();
            })
            .then((detail) => {
              window.__lastDetail = detail;
              const contentEl = buildInfoContent(detail);
              infoWindow.setContent(contentEl);
            })
            .catch((err) => {
              console.error(err);
              infoWindow.setContent('<div style="padding:6px;color:#c00;">読み込みに失敗しました</div>');
            });
        });
        window.__customerMarkers.push(marker);
      });
    }

    function buildCircleMarker(color) {
      const el = document.createElement('div');
      el.style.width = '20px';
      el.style.height = '20px';
      el.style.borderRadius = '50%';
      el.style.background = color;
      el.style.boxShadow = '0 0 0 4px rgba(11,125,218,0.15), 0 2px 6px rgba(0,0,0,0.25)';
      el.style.border = '2px solid #fff';
      el.style.boxSizing = 'border-box';
      return el;
    }

    function buildTriangleMarker(color) {
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      wrapper.style.width = '0';
      wrapper.style.height = '0';
      wrapper.style.borderLeft = '12px solid transparent';
      wrapper.style.borderRight = '12px solid transparent';
      wrapper.style.borderTop = `20px solid ${color}`;
      wrapper.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))';
      return wrapper;
    }

    function renderLoading() {
      return '<div style="padding:6px;">読み込み中...</div>';
    }

    function buildInfoContent(detail) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = renderInfoContent(detail);
      const detailBtn = wrapper.querySelector('.info-detail-btn');
      if (detailBtn) {
        detailBtn.addEventListener('click', () => {
          if (window.__lastDetail) {
            showDetailPanel(window.__lastDetail);
          }
        });
      }
      return wrapper;
    }

    function renderInfoContent(detail) {
      if (!detail || !detail.customer) {
        return '<div style="padding:6px;color:#c00;">データがありません</div>';
      }
      const c = detail.customer;
      const visits = detail.visits || [];
      const btnStyle =
        "padding:6px 12px;border:1px solid #d8c7a7;background:#f2e4cf;border-radius:4px;font-size:12px;cursor:default;box-shadow:inset 0 1px 0 rgba(255,255,255,0.8);";
      const visitList = visits.length
        ? visits
            .map(
              (v) =>
                `<div style="margin:4px 0;">${formatDt(v.start_at)} ${escapeHtml(v.result || '')} ${escapeHtml(
                  v.name || ''
                )}</div>`
            )
            .join("")
        : '<div style="margin-top:4px;">訪問予定なし</div>';

      return `
        <div style="max-width:260px; padding:8px 10px; font-family:'Noto Sans JP', sans-serif; color:#333;">
          <div style="display:flex; gap:6px; margin-bottom:8px;">
            <button style="${btnStyle}">入室</button>
            <button style="${btnStyle}" class="info-detail-btn">詳細</button>
            <button style="${btnStyle}">ルート案内</button>
          </div>
          <div style="font-size:13px; margin-bottom:4px;">
            <span style="font-weight:bold;">顧客名：</span>
            <span style="color:#1a0dab;">${escapeHtml(c.name || '不明')}</span>
          </div>
          <div style="font-size:13px; margin-bottom:4px;">
            <span style="font-weight:bold;">住所：</span>
            <span style="color:#219653;">${escapeHtml(c.address || '')}</span>
          </div>
          <div style="font-size:13px; margin-bottom:6px;">
            <span style="font-weight:bold;">状況：</span>
            <span>${escapeHtml(c.visit_status || '')}</span>
          </div>
          <div style="font-size:13px; font-weight:bold; margin-top:6px;">訪問情報</div>
          <div style="margin-top:4px; border-top:1px solid #888; padding-top:6px; font-size:12px;">
            ${visitList}
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDt(value) {
      if (!value) return '';
      try {
        const d = new Date(value);
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch {
        return value;
      }
    }

    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    // --- 登録モード ---
    function startRegisterMode() {
      const usePosition = (pos) => placeLeadMarker(pos, true);
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (p) => usePosition({ lat: p.coords.latitude, lng: p.coords.longitude }),
          () => usePosition(window.map.getCenter().toJSON())
        );
      } else {
        usePosition(window.map.getCenter().toJSON());
      }
    }

    function placeLeadMarker(position, recenter) {
      if (window.__leadMarker) {
        window.__leadMarker.map = null;
      }
      window.__leadPosition = position;
      const markerEl = document.createElement('div');
      markerEl.style.width = '36px';
      markerEl.style.height = '36px';
      markerEl.style.borderRadius = '50%';
      markerEl.style.background = 'radial-gradient(circle at 30% 30%, #fff 0%, #fff 30%, #ff7f50 60%, #d94c3a 100%)';
      markerEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.25)';
      markerEl.style.border = '2px solid #fff';
      markerEl.style.boxSizing = 'border-box';

      const marker = new google.maps.marker.AdvancedMarkerElement({
        position,
        map: window.map,
        gmpDraggable: true,
        content: buildTriangleMarker('#2e8b57'),
        title: '登録リード位置',
        zIndex: 200
      });

      marker.addListener('dragend', (ev) => {
        const pos = ev.latLng || marker.position;
        window.__leadPosition = { lat: pos.lat(), lng: pos.lng() };
      });

      marker.addListener('click', () => {
        const content = renderLeadRegisterContent(window.__leadPosition);
        window.infoWindow.setContent(content);
        window.infoWindow.open({ anchor: marker, map: window.map });
      });

      window.__leadMarker = marker;
      if (recenter) {
        window.map.setCenter(position);
      }
    }

    function renderLeadRegisterContent(pos) {
      const lat = pos?.lat ?? '';
      const lng = pos?.lng ?? '';
      return `
        <div style="padding:8px; font-family:'Noto Sans JP', sans-serif; min-width:200px;">
          <div style="margin-bottom:6px; font-weight:bold;">新規登録</div>
          <div style="font-size:12px; margin-bottom:6px;">位置: ${lat.toFixed ? lat.toFixed(6) : lat}, ${lng.toFixed ? lng.toFixed(6) : lng}</div>
          <button class="info-btn" onclick="handleLeadRegister()" style="width:100%;">登録</button>
        </div>
      `;
    }

    function handleLeadRegister() {
      const pos = window.__leadPosition;
      if (!pos) return;
      const now = new Date();
      const name = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}登録リード`;
      fetch('/api/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          address: '',
          latitude: pos.lat,
          longitude: pos.lng,
          visit_status: '',
          segment: '',
        }),
      })
        .then((res) => {
          if (!res.ok) throw new Error(`保存に失敗しました (${res.status})`);
          return res.json();
        })
        .then(() => {
          window.infoWindow.setContent('<div style="padding:6px;">登録しました。新しいマーカーを配置しました。</div>');
          // 再度現在地に新規マーカー
          startRegisterMode();
        })
        .catch((err) => {
          console.error(err);
          window.infoWindow.setContent('<div style="padding:6px;color:#c00;">登録に失敗しました</div>');
        });
    }

    function showDetailPanel(detail) {
      const overlay = document.getElementById('detailOverlay');
      const body = document.getElementById('detailPanelBody');
      body.innerHTML = renderDetailPanel(detail);
      overlay.classList.add('open');
    }

    function hideDetailPanel() {
      document.getElementById('detailOverlay').classList.remove('open');
    }

    function showSearchPanel() {
      document.getElementById('searchOverlay').classList.add('open');
    }
    function hideSearchPanel() {
      document.getElementById('searchOverlay').classList.remove('open');
    }

    function openDetailSearchModal() {
      const overlay = document.getElementById('searchModalOverlay');
      overlay.style.display = 'flex';
      loadSearchFields();
    }
    function closeDetailSearchModal() {
      const overlay = document.getElementById('searchModalOverlay');
      overlay.style.display = 'none';
    }

    function loadSearchFields() {
      const body = document.getElementById('searchModalBody');
      body.innerHTML = '<div style="padding:8px;">読み込み中...</div>';
      fetch('/api/search/fields')
        .then((res) => res.json())
        .then((data) => {
          body.innerHTML = renderSearchForm(data);
        })
        .catch((err) => {
          console.error(err);
          body.innerHTML = '<div style="padding:8px;color:#c00;">検索項目の取得に失敗しました</div>';
        });
    }

    function renderSearchForm(data) {
      const customers = (data && data.customers) || [];
      const fields = customers.map((f) => ({ group: '顧客', name: f }));
      const labelize = (name) => name.replace(/_/g, ' ').toUpperCase();
      return `
        <div class="search-form">
          ${fields
            .map(
              (f) => `
                <div class="search-field">
                  <label>${f.group} / ${labelize(f.name)}</label>
                  <input type="text" data-field="${f.name}" />
                </div>
              `
            )
            .join('')}
        </div>
      `;
    }

    function clearSearchForm() {
      document.querySelectorAll('#searchModalBody input').forEach((el) => (el.value = ''));
    }
    function executeSearch() {
      const inputs = Array.from(document.querySelectorAll('#searchModalBody input'));
      const filters = inputs
        .filter((el) => el.value && el.dataset.field)
        .map((el) => ({ field: el.dataset.field, value: el.value }));
      fetch('/api/search/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filters }),
      })
        .then((res) => res.json())
        .then((data) => {
          renderCustomerMarkers(data);
          closeDetailSearchModal();
          hideSearchPanel();
        })
        .catch((err) => {
          console.error(err);
          alert('検索に失敗しました');
        });
    }
    function recordSearch() {
      alert('検索条件の記録（処理は未実装）');
    }

    function renderDetailPanel(detail) {
      if (!detail || !detail.customer) {
        return '<div>データがありません</div>';
      }
      const c = detail.customer;
      const visits = detail.visits || [];
      const firstVisit = visits[0];
      return `
        <div>
          <div class="detail-btn-row">
            <button class="detail-ghost-btn">訪問入室</button>
            <button class="detail-ghost-btn">訪問登録</button>
            <button class="detail-ghost-btn">ルート案内</button>
            <button class="detail-ghost-btn">編集</button>
          </div>
          <div class="detail-section">
            <div class="detail-section-title">顧客情報</div>
            <table class="detail-table">
              <tr><td class="label">顧客名</td><td>${escapeHtml(c.name || '')}</td></tr>
              <tr><td class="label">住所</td><td>${escapeHtml(c.address || '')}</td></tr>
              <tr><td class="label">ステータス</td><td>${escapeHtml(c.visit_status || '')}</td></tr>
              <tr><td class="label">顧客属性</td><td>${escapeHtml(c.segment || '')}</td></tr>
            </table>
          </div>
          <div class="detail-section">
            <div class="detail-section-title">訪問予定</div>
            ${renderVisitTables(visits, c.visit_status)}
          </div>
        </div>
      `;
    }

    function renderVisitTables(visits, customerStatus) {
      if (!visits || visits.length === 0) {
        return '<div style="padding:8px;">訪問予定なし</div>';
      }
      return visits
        .map((v) => {
          const start = formatDt(v.start_at);
          const end = formatDt(v.end_at);
          return `
            <table class="detail-table" style="margin-bottom:8px;">
              <tr><td class="label">訪問予定名</td><td>${escapeHtml(v.name || '')}</td></tr>
              <tr><td class="label">開始/終了</td><td>${start} ～ ${end}</td></tr>
              <tr><td class="label">状況</td><td>${escapeHtml(customerStatus || '')}</td></tr>
              <tr><td class="label">訪問結果</td><td>${escapeHtml(v.result || '')}</td></tr>
              <tr><td class="label">詳細</td><td>${escapeHtml(v.detail || '')}</td></tr>
            </table>
          `;
        })
        .join('');
    }

    // 認証系エラー(ExpiredKeyMapError 等)で呼ばれる
    window.gm_authFailure = function () {
      const errBox = document.getElementById('mapError');
      if (errBox) errBox.style.display = 'block';
      console.error('Google Maps authentication failed (e.g., expired key).');
    };
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=marker&map_ids={{ map_id }}" async defer></script>
</body>
</html>
