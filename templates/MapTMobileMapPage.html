<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapTech</title>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:"Roboto", sans-serif; }
    #header {
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      padding:10px;
      position:fixed;
      top:0;
      width:100%;
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:flex-start;
    }
    .header-title { font-size:18px; }
    #mapMenu {
      background:#fff;
      border-bottom:1px solid #dcdcdc;
      position:fixed;
      top:50px;
      left:0;
      width:100%;
      min-height:30px;
      max-height:30px;
      overflow:hidden;
      transition:max-height 0.2s ease;
      z-index:999;
    }
    #mapMenu.expanded { max-height:220px; }
    #mapMenuHeader { display:flex; align-items:center; padding:0 10px; height:30px; cursor:pointer; }
    #mapMenuContent { display:none; padding:6px 10px 8px; }
    #mapMenu.expanded #mapMenuContent { display:block; }
    .menu-buttons { display:flex; flex-wrap:wrap; gap:6px; }
    .mapTButton { padding:5px 10px; background:#eee; border-radius:4px; text-decoration:none; color:#333; }
    #map {
      width:100%;
      height:calc(100% - 50px);
      margin-top:50px;
    }
    /* Detail side panel */
    #detailOverlay {
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:0;
      overflow:hidden;
      background:rgba(0,0,0,0.25);
      transition:width 0.3s ease;
      z-index:1300;
    }
    #detailPanel {
      position:absolute;
      top:0;
      right:-480px;
      width:480px;
      height:100%;
      background:#fff;
      box-shadow:-2px 0 8px rgba(0,0,0,0.15);
      transition:right 0.3s ease;
      display:flex;
      flex-direction:column;
      padding:12px;
      box-sizing:border-box;
      overflow-y:auto;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    #detailOverlay.open { width:100%; }
    #detailOverlay.open #detailPanel { right:0; }
    .detail-panel-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .detail-title {
      font-size:16px;
      font-weight:bold;
      color:#5a8a1f;
    }
    .detail-close {
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
    }
    .detail-btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .detail-ghost-btn {
      padding:8px 14px;
      border:1px solid #d1d5db;
      border-radius:6px;
      background:#f7f7f7;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.9);
      cursor:default;
    }
    .detail-section {
      border:1px solid #e5e7eb;
      margin-bottom:12px;
      border-radius:4px;
      overflow:hidden;
    }
    .detail-section-title {
      background:#f9fafb;
      padding:8px 10px;
      font-weight:bold;
      border-bottom:1px solid #e5e7eb;
    }
    .detail-table { width:100%; border-collapse:collapse; }
    .detail-table td {
      border-top:1px solid #e5e7eb;
      padding:8px;
      font-size:13px;
    }
    .detail-table td.label {
      background:#f5f5f5;
      width:28%;
      font-weight:bold;
    }
    .info-btn {
      padding:6px 12px;
      border:1px solid #d8c7a7;
      background:#f2e4cf;
      border-radius:4px;
      font-size:12px;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.8);
    }
    /* Search side panel (compact) */
    #searchOverlay {
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:0;
      overflow:hidden;
      background:rgba(0,0,0,0.25);
      transition:width 0.3s ease;
      z-index:1250;
    }
    #searchPanel {
      position:absolute;
      top:0;
      right:-340px;
      width:340px;
      height:100%;
      background:#fff;
      box-shadow:-2px 0 8px rgba(0,0,0,0.15);
      transition:right 0.3s ease;
      display:flex;
      flex-direction:column;
      padding:12px;
      box-sizing:border-box;
      overflow-y:auto;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    #searchOverlay.open { width:100%; }
    #searchOverlay.open #searchPanel { right:0; }
    .search-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .search-title { color:#6ea400; font-weight:bold; font-size:16px; }
    .search-close {
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
    }
    .search-item {
      border:1px solid #d1d5db;
      border-radius:6px;
      padding:10px 12px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .search-icon {
      width:24px;
      height:24px;
      border:2px solid #8c8c8c;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#8c8c8c;
      font-size:12px;
      box-sizing:border-box;
    }
    .search-label {
      font-size:13px;
      color:#333;
    }
    /* Modal for detail search */
    #searchModalOverlay {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1400;
    }
    #searchModal {
      background:#fff;
      width:80%;
      max-width:720px;
      max-height:80%;
      overflow:auto;
      border-radius:8px;
      box-shadow:0 6px 16px rgba(0,0,0,0.25);
      padding:16px;
      box-sizing:border-box;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    .search-modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .search-modal-title { font-size:16px; font-weight:bold; }
    .search-modal-close { background:none; border:none; font-size:20px; cursor:pointer; }
    .search-form {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
      gap:12px;
      margin-bottom:12px;
    }
    .search-field {
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
    }
    .search-field label { font-weight:bold; }
    .search-field input {
      padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:4px;
      font-size:12px;
    }
    .search-modal-actions {
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .search-modal-actions button {
      padding:8px 14px;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#f7f7f7;
      cursor:pointer;
    }
    .search-modal-actions .primary {
      background:#4caf50;
      color:#fff;
      border-color:#4caf50;
    }
    .edit-btn-row { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
    .edit-primary {
      padding:8px 12px;
      border:1px solid #4caf50;
      background:#4caf50;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
    }
    .edit-secondary {
      padding:8px 12px;
      border:1px solid #d1d5db;
      background:#f7f7f7;
      border-radius:6px;
      cursor:pointer;
    }
    .edit-input {
      width:100%;
      padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:4px;
      box-sizing:border-box;
      font-size:12px;
    }
    .detail-item { padding:8px 10px; border-bottom:1px solid #e5e7eb; }
    .detail-item:last-child { border-bottom:none; }
    .detail-item-label { font-weight:bold; font-size:13px; margin-bottom:2px; }
    .detail-item-value { font-size:13px; }
    /* Visit register modal */
    #visitModalOverlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1450;
    }
    #visitModal {
      background:#fff;
      width:340px;
      max-width:90%;
      border-radius:8px;
      box-shadow:0 6px 16px rgba(0,0,0,0.25);
      padding:16px;
      box-sizing:border-box;
      font-family:"Roboto","Noto Sans JP",sans-serif;
    }
    #visitModal h3 { margin:0 0 12px; font-size:16px; }
    .visit-field { margin-bottom:10px; display:flex; flex-direction:column; gap:4px; }
    .visit-field input {
      padding:8px;
      border:1px solid #d1d5db;
      border-radius:4px;
      font-size:12px;
    }
    .visit-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .visit-actions button {
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#f7f7f7;
      cursor:pointer;
    }
    .visit-actions .primary {
      background:#4caf50;
      color:#fff;
      border-color:#4caf50;
    }
    .delete-btn {
      padding:6px 10px;
      border:1px solid #d9534f;
      background:#d9534f;
      color:#fff;
      border-radius:4px;
      cursor:pointer;
      font-size:12px;
    }
  </style>
</head>
<body>
  <div id="header">
    <div class="header-title">MapTech 地図モバイル</div>
  </div>

  <div id="mapMenu" class="expanded">
    <div id="mapMenuHeader">
      <span id="hideLink">▼ メニュー</span>
      <span id="showLink" style="display:none;">▶ メニュー</span>
    </div>
    <div id="mapMenuContent">
      <div class="menu-buttons">
        <a href="#" class="mapTButton" onclick="openSetting()">ユーザ設定</a>
        <a href="#" class="mapTButton" onclick="searchRecords()">検索</a>
        <a href="#" class="mapTButton" onclick="showRoute()">ルート</a>
        <a href="#" class="mapTButton" onclick="registerLead()">登録モード</a>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div id="mapError" style="display:none; position:fixed; top:60px; left:10px; right:10px; padding:10px; background:#fff3cd; color:#664d03; border:1px solid #ffeeba; border-radius:4px; z-index:1200;">
    Googleマップを読み込めませんでした。APIキーが期限切れか権限不足の可能性があります。キーを再発行し、必要なAPIと課金・リファラー設定をご確認ください。
  </div>

  <div id="detailOverlay">
    <div id="detailPanel">
      <div class="detail-panel-header">
        <div class="detail-title">情報詳細</div>
        <button class="detail-close" onclick="hideDetailPanel()">×</button>
      </div>
      <div id="detailPanelBody"></div>
    </div>
  </div>

  <div id="searchOverlay">
    <div id="searchPanel">
      <div class="search-header">
        <div class="search-title">検索</div>
        <button class="search-close" onclick="hideSearchPanel()">×</button>
      </div>
      <div class="search-item" onclick="openDetailSearchModal()"><div class="search-icon">🔍</div><div class="search-label">詳細検索</div></div>
      <div class="search-item"><div class="search-icon">📝</div><div class="search-label">記録条件検索</div></div>
      <div class="search-item"><div class="search-icon">👤</div><div class="search-label">担当顧客</div></div>
      <div class="search-item"><div class="search-icon">📍</div><div class="search-label">担当エリア</div></div>
      <div class="search-item"><div class="search-icon">👥</div><div class="search-label">所属グループ</div></div>
    </div>
  </div>

  <div id="searchModalOverlay">
    <div id="searchModal">
      <div class="search-modal-header">
        <div class="search-modal-title">詳細検索</div>
        <button class="search-modal-close" onclick="closeDetailSearchModal()">×</button>
      </div>
      <div id="searchModalBody">
        <div style="padding:8px;">読み込み中...</div>
      </div>
      <div class="search-modal-actions">
        <button onclick="clearSearchForm()">検索条件クリア</button>
        <button class="primary" onclick="executeSearch()">検索実行</button>
        <button onclick="recordSearch()">検索条件の記録</button>
      </div>
    </div>
  </div>

  <div id="visitModalOverlay">
    <div id="visitModal">
      <h3>訪問登録</h3>
      <div class="visit-field">
        <label>訪問名</label>
        <input type="text" id="visitName" value="訪問" />
      </div>
      <div class="visit-field">
        <label>開始日時</label>
        <input type="datetime-local" id="visitStart" />
      </div>
      <div class="visit-field">
        <label>終了日時</label>
        <input type="datetime-local" id="visitEnd" />
      </div>
      <div class="visit-actions">
        <button onclick="closeVisitModal()">キャンセル</button>
        <button class="primary" onclick="submitVisit()">登録</button>
      </div>
      <div id="visitError" style="color:#c00; font-size:12px; min-height:16px;"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mapMenu = document.getElementById('mapMenu');
      const hideLink = document.getElementById('hideLink');
      const showLink = document.getElementById('showLink');
      window.customerIconUrl = "/static/Home/FFFFFF.png";

      hideLink.addEventListener('click', () => {
        mapMenu.classList.remove('expanded');
        hideLink.style.display = 'none';
        showLink.style.display = 'inline';
      });

      showLink.addEventListener('click', () => {
        mapMenu.classList.add('expanded');
        hideLink.style.display = 'inline';
        showLink.style.display = 'none';
      });
    });

    window.initMap = function () {
      const defaultPos = { lat: 35.681236, lng: 139.767125 };
      const map = new google.maps.Map(document.getElementById('map'), {
        center: defaultPos,
        zoom: 13,
        mapId: "{{ map_id }}"
      });
      window.map = map;
      const infoWindow = new google.maps.InfoWindow({ content: "" });
      window.infoWindow = infoWindow;
      window.__leadMarker = null;
      window.__leadPosition = null;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userPos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            const userMarker = new google.maps.marker.AdvancedMarkerElement({
              position: userPos,
              map,
              title: '現在地',
              zIndex: 10,
              content: buildCircleMarker('#0b7dda')
            });
            userMarker.addListener('click', () => infoWindow.open({ anchor: userMarker, map }));
            map.setCenter(userPos);
          },
          (error) => console.error('Geolocation error:', error)
        );
      }

      fetch('/api/markers')
        .then((res) => res.json())
        .then((data) => {
          renderCustomerMarkers(data);
        })
        .catch((err) => console.error('Markers fetch error:', err));
    };

    function openSetting() { alert('設定画面を開きます'); }
    function searchRecords() { showSearchPanel(); }
    function showRoute() { alert('ルート表示を実行します'); }
    function registerLead() { startRegisterMode(); }

    function buildMarkerContent(iconUrl, title) {
      const img = document.createElement('img');
      img.src = iconUrl;
      img.alt = title || 'marker';
      img.style.width = '36px';
      img.style.height = '36px';
      img.style.objectFit = 'contain';
      return img;
    }

    function renderCustomerMarkers(data) {
      const infoWindow = window.infoWindow;
      if (window.__customerMarkers && window.__customerMarkers.length) {
        window.__customerMarkers.forEach((mk) => (mk.map = null));
      }
      window.__customerMarkers = [];
      data.forEach((m) => {
        const marker = new google.maps.marker.AdvancedMarkerElement({
          position: { lat: m.lat, lng: m.lng },
          map: window.map,
          title: m.title,
          content: buildMarkerContent(window.customerIconUrl, m.title),
          zIndex: 100,
        });
        marker.addListener('click', () => {
          const pos = marker.position;
          if (pos) {
            const latVal = typeof pos.lat === 'function' ? pos.lat() : pos.lat;
            const lngVal = typeof pos.lng === 'function' ? pos.lng() : pos.lng;
            if (latVal != null && lngVal != null) {
              window.map.setCenter({ lat: latVal, lng: lngVal });
            }
          }
          infoWindow.close();
          infoWindow.setContent(renderLoading());
          infoWindow.open({ anchor: marker, map: window.map });
          fetch(`/api/customers/${m.id}/detail`)
            .then((res) => {
              if (!res.ok) throw new Error(`Failed to load detail: ${res.status}`);
              return res.json();
            })
            .then((detail) => {
              window.__lastDetail = detail;
              const contentEl = buildInfoContent(detail);
              infoWindow.setContent(contentEl);
            })
            .catch((err) => {
              console.error(err);
              infoWindow.setContent('<div style="padding:6px;color:#c00;">読み込みに失敗しました</div>');
            });
        });
        window.__customerMarkers.push(marker);
      });
    }

    function buildCircleMarker(color) {
      const el = document.createElement('div');
      el.style.width = '20px';
      el.style.height = '20px';
      el.style.borderRadius = '50%';
      el.style.background = color;
      el.style.boxShadow = '0 0 0 4px rgba(11,125,218,0.15), 0 2px 6px rgba(0,0,0,0.25)';
      el.style.border = '2px solid #fff';
      el.style.boxSizing = 'border-box';
      return el;
    }

    function buildTriangleMarker(color) {
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      wrapper.style.width = '0';
      wrapper.style.height = '0';
      wrapper.style.borderLeft = '12px solid transparent';
      wrapper.style.borderRight = '12px solid transparent';
      wrapper.style.borderTop = `20px solid ${color}`;
      wrapper.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))';
      return wrapper;
    }

    function renderLoading() {
      return '<div style="padding:6px;">読み込み中...</div>';
    }

    function buildInfoContent(detail) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = renderInfoContent(detail);
      const detailBtn = wrapper.querySelector('.info-detail-btn');
      if (detailBtn) {
        detailBtn.addEventListener('click', () => {
          if (window.__lastDetail) {
            showDetailPanel(window.__lastDetail);
          }
        });
      }
      const enterBtn = wrapper.querySelector('.info-enter-btn');
      if (enterBtn && detail && detail.customer) {
        enterBtn.addEventListener('click', () => registerImmediateVisit(detail.customer.id));
      }
      return wrapper;
    }

    function renderInfoContent(detail) {
      if (!detail || !detail.customer) {
        return '<div style="padding:6px;color:#c00;">データがありません</div>';
      }
      const c = detail.customer;
      const visits = detail.visits || [];
      const btnStyle =
        "padding:6px 12px;border:1px solid #d8c7a7;background:#f2e4cf;border-radius:4px;font-size:12px;cursor:default;box-shadow:inset 0 1px 0 rgba(255,255,255,0.8);";
      const visitList = visits.length
        ? visits
            .map(
              (v) =>
                `<div style="margin:4px 0;">${formatDt(v.start_at)} ${escapeHtml(v.result || '')} ${escapeHtml(
                  v.name || ''
                )}</div>`
            )
            .join("")
        : '<div style="margin-top:4px;">訪問予定なし</div>';

      return `
        <div style="max-width:260px; padding:8px 10px; font-family:'Noto Sans JP', sans-serif; color:#333;">
          <div style="display:flex; gap:6px; margin-bottom:8px;">
            <button style="${btnStyle}" class="info-enter-btn">入室</button>
            <button style="${btnStyle}" class="info-detail-btn">詳細</button>
            <button style="${btnStyle}">ルート案内</button>
          </div>
          <div style="font-size:13px; margin-bottom:4px;">
            <span style="font-weight:bold;">顧客名：</span>
            <span style="color:#1a0dab;">${escapeHtml(c.name || '不明')}</span>
          </div>
          <div style="font-size:13px; margin-bottom:4px;">
            <span style="font-weight:bold;">住所：</span>
            <span style="color:#219653;">${escapeHtml(c.address || '')}</span>
          </div>
          <div style="font-size:13px; margin-bottom:6px;">
            <span style="font-weight:bold;">状況：</span>
            <span>${escapeHtml(c.visit_status || '')}</span>
          </div>
          <div style="font-size:13px; font-weight:bold; margin-top:6px;">訪問情報</div>
          <div style="margin-top:4px; border-top:1px solid #888; padding-top:6px; font-size:12px;">
            ${visitList}
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDt(value) {
      if (!value) return '';
      try {
        const d = new Date(value);
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch {
        return value;
      }
    }

    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    // --- 登録モード ---
    function startRegisterMode() {
      const usePosition = (pos) => placeLeadMarker(pos, true);
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (p) => usePosition({ lat: p.coords.latitude, lng: p.coords.longitude }),
          () => usePosition(window.map.getCenter().toJSON())
        );
      } else {
        usePosition(window.map.getCenter().toJSON());
      }
    }

    function placeLeadMarker(position, recenter) {
      if (window.__leadMarker) {
        window.__leadMarker.map = null;
      }
      window.__leadPosition = position;
      const markerEl = document.createElement('div');
      markerEl.style.width = '36px';
      markerEl.style.height = '36px';
      markerEl.style.borderRadius = '50%';
      markerEl.style.background = 'radial-gradient(circle at 30% 30%, #fff 0%, #fff 30%, #ff7f50 60%, #d94c3a 100%)';
      markerEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.25)';
      markerEl.style.border = '2px solid #fff';
      markerEl.style.boxSizing = 'border-box';

      const marker = new google.maps.marker.AdvancedMarkerElement({
        position,
        map: window.map,
        gmpDraggable: true,
        content: buildTriangleMarker('#2e8b57'),
        title: '登録リード位置',
        zIndex: 200
      });

      marker.addListener('dragend', (ev) => {
        const pos = ev.latLng || marker.position;
        window.__leadPosition = { lat: pos.lat(), lng: pos.lng() };
      });

      marker.addListener('click', () => {
        const content = renderLeadRegisterContent(window.__leadPosition);
        window.infoWindow.setContent(content);
        window.infoWindow.open({ anchor: marker, map: window.map });
      });

      window.__leadMarker = marker;
      if (recenter) {
        window.map.setCenter(position);
      }
    }

    function renderLeadRegisterContent(pos) {
      const lat = pos?.lat ?? '';
      const lng = pos?.lng ?? '';
      return `
        <div style="padding:8px; font-family:'Noto Sans JP', sans-serif; min-width:200px;">
          <div style="margin-bottom:6px; font-weight:bold;">新規登録</div>
          <div style="font-size:12px; margin-bottom:6px;">位置: ${lat.toFixed ? lat.toFixed(6) : lat}, ${lng.toFixed ? lng.toFixed(6) : lng}</div>
          <button class="info-btn" onclick="handleLeadRegister()" style="width:100%;">登録</button>
        </div>
      `;
    }

    function handleLeadRegister() {
      const pos = window.__leadPosition;
      if (!pos) return;
      const now = new Date();
      const name = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}登録リード`;
      fetch('/api/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          address: '',
          latitude: pos.lat,
          longitude: pos.lng,
          visit_status: '',
          segment: '',
        }),
      })
        .then((res) => {
          if (!res.ok) throw new Error(`保存に失敗しました (${res.status})`);
          return res.json();
        })
        .then(() => {
          window.infoWindow.setContent('<div style="padding:6px;">登録しました。新しいマーカーを配置しました。</div>');
          // 再度現在地に新規マーカー
          startRegisterMode();
        })
        .catch((err) => {
          console.error(err);
          window.infoWindow.setContent('<div style="padding:6px;color:#c00;">登録に失敗しました</div>');
        });
    }

    // --- Detail edit mode ---
    function enterDetailEditMode() {
      window.__detailEditMode = true;
      const body = document.getElementById('detailPanelBody');
      body.innerHTML = renderDetailPanel(window.__lastDetail);
      attachEditModeHandlers();
    }

    function attachEditModeHandlers() {
      const saveBtn = document.querySelector('.detail-save-btn');
      const cancelBtn = document.querySelector('.detail-cancel-btn');
      if (saveBtn) saveBtn.addEventListener('click', saveDetailEdits);
      if (cancelBtn) cancelBtn.addEventListener('click', cancelDetailEdits);
    }

    function cancelDetailEdits() {
      window.__detailEditMode = false;
      const body = document.getElementById('detailPanelBody');
      body.innerHTML = renderDetailPanel(window.__lastDetail);
      const btn = body.querySelector('.visit-register-btn');
      if (btn) btn.addEventListener('click', () => openVisitModal());
      const editBtn = body.querySelector('.detail-edit-btn');
      if (editBtn) editBtn.addEventListener('click', () => enterDetailEditMode());
    }

    function renderDetailPanelEdit(c, visits) {
      const visitInputs = (visits || [])
        .map(
          (v) => `
            <div class="detail-section" data-visit-id="${v.id}">
              <div class="detail-section-title">訪問予定 (ID: ${v.id})</div>
              <div style="padding:8px; display:flex; flex-direction:column; gap:8px;">
                <div>
                  <label style="font-weight:bold;font-size:12px;">訪問予定名</label>
                  <input class="edit-input visit-name" value="${escapeHtml(v.name || '')}" />
                </div>
                <div>
                  <label style="font-weight:bold;font-size:12px;">訪問結果</label>
                  <input class="edit-input visit-result" value="${escapeHtml(v.result || '')}" />
                </div>
                <div>
                  <label style="font-weight:bold;font-size:12px;">開始</label>
                  <input type="datetime-local" class="edit-input visit-start" value="${toLocalInputStr(v.start_at)}" />
                </div>
                <div>
                  <label style="font-weight:bold;font-size:12px;">終了</label>
                  <input type="datetime-local" class="edit-input visit-end" value="${toLocalInputStr(v.end_at)}" />
                </div>
                <div>
                  <label style="font-weight:bold;font-size:12px;">詳細</label>
                  <input class="edit-input visit-detail" value="${escapeHtml(v.detail || '')}" />
                </div>
                <div style="display:flex; justify-content:flex-end;">
                  <button class="delete-btn" onclick="deleteVisit(${v.id})">削除</button>
                </div>
              </div>
            </div>
          `
        )
        .join('');

      return `
        <div>
          <div class="edit-btn-row">
            <button class="edit-primary detail-save-btn">保存</button>
            <button class="edit-secondary detail-cancel-btn">キャンセル</button>
          </div>
          <div class="detail-section">
            <div class="detail-section-title">顧客情報</div>
            <div style="padding:8px; display:flex; flex-direction:column; gap:8px;">
              <div>
                <label style="font-weight:bold;font-size:12px;">顧客名</label>
                <input class="edit-input cust-name" value="${escapeHtml(c.name || '')}" />
              </div>
              <div>
                <label style="font-weight:bold;font-size:12px;">顧客属性</label>
                <input class="edit-input cust-segment" value="${escapeHtml(c.segment || '')}" />
              </div>
              <div>
                <label style="font-weight:bold;font-size:12px;">住所</label>
                <input class="edit-input cust-address" value="${escapeHtml(c.address || '')}" />
              </div>
              <div>
                <label style="font-weight:bold;font-size:12px;">ステータス</label>
                <input class="edit-input cust-status" value="${escapeHtml(c.visit_status || '')}" />
              </div>
            </div>
          </div>
          <div>
            ${visitInputs || '<div style="padding:8px;">訪問予定なし</div>'}
          </div>
        </div>
      `;
    }

    function toLocalInputStr(value) {
      if (!value) return '';
      try {
        const d = new Date(value);
        const pad2 = (n) => n.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      } catch {
        return '';
      }
    }

    async function saveDetailEdits() {
      const d = window.__lastDetail;
      if (!d || !d.customer) return;
      const body = document.getElementById('detailPanelBody');
      const custPayload = {
        name: body.querySelector('.cust-name')?.value || '',
        address: body.querySelector('.cust-address')?.value || '',
        latitude: d.customer.latitude,
        longitude: d.customer.longitude,
        visit_status: body.querySelector('.cust-status')?.value || '',
        segment: body.querySelector('.cust-segment')?.value || '',
      };

      const visitSections = Array.from(body.querySelectorAll('[data-visit-id]'));
      const visitPayloads = visitSections.map((section) => {
        const id = section.getAttribute('data-visit-id');
        return {
          id,
          name: section.querySelector('.visit-name')?.value || '',
          start_at: section.querySelector('.visit-start')?.value || '',
          end_at: section.querySelector('.visit-end')?.value || '',
          result: section.querySelector('.visit-result')?.value || '',
          detail: section.querySelector('.visit-detail')?.value || '',
        };
      });

      try {
        await fetch(`/api/customers/${d.customer.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(custPayload),
        }).then((res) => {
          if (!res.ok) throw new Error('顧客情報の保存に失敗しました');
        });
        for (const v of visitPayloads) {
          await fetch(`/api/visits/${v.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: v.name,
              start_at: v.start_at,
              end_at: v.end_at,
              result: v.result,
              detail: v.detail,
              customer_id: d.customer.id,
            }),
          }).then((res) => {
            if (!res.ok) throw new Error('訪問予定の保存に失敗しました');
          });
        }
        const newDetail = await fetch(`/api/customers/${d.customer.id}/detail`).then((res) => res.json());
        window.__lastDetail = newDetail;
        window.__detailEditMode = false;
        const updated = renderDetailPanel(newDetail);
        body.innerHTML = updated;
        const btn = body.querySelector('.visit-register-btn');
        if (btn) btn.addEventListener('click', () => openVisitModal());
        const editBtn = body.querySelector('.detail-edit-btn');
        if (editBtn) editBtn.addEventListener('click', () => enterDetailEditMode());
      } catch (err) {
        console.error(err);
        alert('保存に失敗しました');
      }
    }

    async function deleteVisit(id) {
      if (!confirm('この訪問予定を削除しますか？')) return;
      try {
        await fetch(`/api/visits/${id}`, { method: 'DELETE' }).then((res) => {
          if (!res.ok) throw new Error('削除に失敗しました');
        });
        // Refresh detail
        const d = window.__lastDetail;
        if (d && d.customer) {
          const newDetail = await fetch(`/api/customers/${d.customer.id}/detail`).then((res) => res.json());
          window.__lastDetail = newDetail;
          window.__detailEditMode = true; // stay in edit mode after delete
          const body = document.getElementById('detailPanelBody');
          body.innerHTML = renderDetailPanel(newDetail);
          attachEditModeHandlers();
        }
      } catch (err) {
        console.error(err);
        alert('削除に失敗しました');
      }
    }

    function showDetailPanel(detail) {
      const overlay = document.getElementById('detailOverlay');
      const body = document.getElementById('detailPanelBody');
      window.__detailEditMode = false;
      body.innerHTML = renderDetailPanel(detail);
      overlay.classList.add('open');
      wireDetailButtons(body);
    }

    function wireDetailButtons(body) {
      const btn = body.querySelector('.visit-register-btn');
      if (btn) btn.addEventListener('click', () => openVisitModal());
      const editBtn = body.querySelector('.detail-edit-btn');
      if (editBtn) editBtn.addEventListener('click', () => enterDetailEditMode());
    }

    function hideDetailPanel() {
      document.getElementById('detailOverlay').classList.remove('open');
    }

    function showSearchPanel() {
      document.getElementById('searchOverlay').classList.add('open');
    }
    function hideSearchPanel() {
      document.getElementById('searchOverlay').classList.remove('open');
    }

    function openDetailSearchModal() {
      const overlay = document.getElementById('searchModalOverlay');
      overlay.style.display = 'flex';
      loadSearchFields();
    }
    function closeDetailSearchModal() {
      const overlay = document.getElementById('searchModalOverlay');
      overlay.style.display = 'none';
    }

    function loadSearchFields() {
      const body = document.getElementById('searchModalBody');
      body.innerHTML = '<div style="padding:8px;">読み込み中...</div>';
      fetch('/api/search/fields')
        .then((res) => res.json())
        .then((data) => {
          body.innerHTML = renderSearchForm(data);
        })
        .catch((err) => {
          console.error(err);
          body.innerHTML = '<div style="padding:8px;color:#c00;">検索項目の取得に失敗しました</div>';
        });
    }

    function renderSearchForm(data) {
      const customers = (data && data.customers) || [];
      const fields = customers.map((f) => ({ group: '顧客', name: f }));
      const labelize = (name) => name.replace(/_/g, ' ').toUpperCase();
      return `
        <div class="search-form">
          ${fields
            .map(
              (f) => `
                <div class="search-field">
                  <label>${f.group} / ${labelize(f.name)}</label>
                  <input type="text" data-field="${f.name}" />
                </div>
              `
            )
            .join('')}
        </div>
      `;
    }

    function clearSearchForm() {
      document.querySelectorAll('#searchModalBody input').forEach((el) => (el.value = ''));
    }
    function executeSearch() {
      const inputs = Array.from(document.querySelectorAll('#searchModalBody input'));
      const filters = inputs
        .filter((el) => el.value && el.dataset.field)
        .map((el) => ({ field: el.dataset.field, value: el.value }));
      fetch('/api/search/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filters }),
      })
        .then((res) => res.json())
        .then((data) => {
          renderCustomerMarkers(data);
          closeDetailSearchModal();
          hideSearchPanel();
        })
        .catch((err) => {
          console.error(err);
          alert('検索に失敗しました');
        });
    }
    function recordSearch() {
      alert('検索条件の記録（処理は未実装）');
    }

    // --- Visit modal ---
    function openVisitModal() {
      const d = window.__lastDetail;
      if (!d || !d.customer) {
        alert('顧客情報がありません');
        return;
      }
      const now = new Date();
      const plus1h = new Date(now.getTime() + 60 * 60 * 1000);
      document.getElementById('visitName').value = '訪問';
      document.getElementById('visitStart').value = toLocalInput(now);
      document.getElementById('visitEnd').value = toLocalInput(plus1h);
      document.getElementById('visitError').textContent = '';
      document.getElementById('visitModalOverlay').style.display = 'flex';
    }
    function closeVisitModal() {
      document.getElementById('visitModalOverlay').style.display = 'none';
    }
    function toLocalInput(dateObj) {
      const pad2 = (n) => n.toString().padStart(2, '0');
      return `${dateObj.getFullYear()}-${pad2(dateObj.getMonth() + 1)}-${pad2(dateObj.getDate())}T${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;
    }
    function toIsoString(dateObj) {
      return dateObj.toISOString();
    }
    function submitVisit() {
      const d = window.__lastDetail;
      if (!d || !d.customer) {
        document.getElementById('visitError').textContent = '顧客情報がありません';
        return;
      }
      const name = document.getElementById('visitName').value || '訪問';
      const start_at = document.getElementById('visitStart').value;
      const end_at = document.getElementById('visitEnd').value;
      fetch('/api/visits', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          start_at,
          end_at,
          customer_id: d.customer.id,
          result: '',
          detail: '',
        }),
        })
        .then((res) => {
          if (!res.ok) throw new Error(`登録に失敗しました (${res.status})`);
          return res.json();
        })
        .then(() => {
          closeVisitModal();
          // 最新の顧客詳細を取得して右スライダーをリフレッシュ
          fetch(`/api/customers/${d.customer.id}/detail`)
            .then((res) => {
              if (!res.ok) throw new Error(`詳細取得に失敗しました (${res.status})`);
              return res.json();
            })
            .then((detail) => {
              window.__lastDetail = detail;
              const body = document.getElementById('detailPanelBody');
              body.innerHTML = renderDetailPanel(detail);
              const btn = body.querySelector('.visit-register-btn');
              if (btn) btn.addEventListener('click', () => openVisitModal());
            })
            .catch((err) => {
              console.error(err);
              alert('詳細の更新に失敗しました');
            });
          alert('訪問予定を登録しました');
        })
        .catch((err) => {
          console.error(err);
          document.getElementById('visitError').textContent = '登録に失敗しました';
        });
    }

    async function registerImmediateVisit(customerId) {
      const now = new Date();
      if (!confirm('訪問予定を登録します。よろしいですか？')) return;
      try {
        await fetch('/api/visits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: '入室',
            start_at: toIsoString(now),
            end_at: '',
            result: '訪問中',
            detail: '',
            customer_id: customerId,
          }),
        }).then((res) => {
          if (!res.ok) throw new Error(`登録に失敗しました (${res.status})`);
          return res.json();
        });
        // Refresh detail so panel shows latest visits
        const newDetail = await fetch(`/api/customers/${customerId}/detail`).then((res) => res.json());
        window.__lastDetail = newDetail;
        // If detail panel is open, refresh it
        const overlay = document.getElementById('detailOverlay');
        if (overlay.classList.contains('open')) {
          const body = document.getElementById('detailPanelBody');
          body.innerHTML = renderDetailPanel(newDetail);
          wireDetailButtons(body);
        }
        alert('訪問予定を登録しました');
      } catch (err) {
        console.error(err);
        alert('訪問予定の登録に失敗しました');
      }
    }

    function renderDetailPanel(detail) {
      if (!detail || !detail.customer) {
        return '<div>データがありません</div>';
      }
      const c = detail.customer;
      const visits = detail.visits || [];
      if (window.__detailEditMode) {
        return renderDetailPanelEdit(c, visits);
      }
      return `
        <div>
          <div class="detail-btn-row">
            <button class="detail-ghost-btn">訪問入室</button>
            <button class="detail-ghost-btn visit-register-btn">訪問登録</button>
            <button class="detail-ghost-btn">ルート案内</button>
            <button class="detail-ghost-btn detail-edit-btn">編集</button>
          </div>
          <div class="detail-section">
            <div class="detail-section-title">顧客情報</div>
            <div class="detail-item"><div class="detail-item-label">顧客名</div><div class="detail-item-value">${escapeHtml(c.name || '')}</div></div>
            <div class="detail-item"><div class="detail-item-label">住所</div><div class="detail-item-value">${escapeHtml(c.address || '')}</div></div>
            <div class="detail-item"><div class="detail-item-label">ステータス</div><div class="detail-item-value">${escapeHtml(c.visit_status || '')}</div></div>
            <div class="detail-item"><div class="detail-item-label">顧客属性</div><div class="detail-item-value">${escapeHtml(c.segment || '')}</div></div>
          </div>
          <div class="detail-section">
            <div class="detail-section-title">訪問予定</div>
            ${renderVisitTables(visits, c.visit_status)}
          </div>
        </div>
      `;
    }

    function renderVisitTables(visits, customerStatus) {
      if (!visits || visits.length === 0) {
        return '<div style="padding:8px;">訪問予定なし</div>';
      }
      return visits
        .map((v) => {
          const start = formatDt(v.start_at);
          const end = formatDt(v.end_at);
          return `
            <div class="detail-section" style="margin-bottom:8px;">
              <div class="detail-item"><div class="detail-item-label">訪問予定名</div><div class="detail-item-value">${escapeHtml(v.name || '')}</div></div>
              <div class="detail-item"><div class="detail-item-label">開始/終了</div><div class="detail-item-value">${start} ～ ${end}</div></div>
              <div class="detail-item"><div class="detail-item-label">状況</div><div class="detail-item-value">${escapeHtml(customerStatus || '')}</div></div>
              <div class="detail-item"><div class="detail-item-label">訪問結果</div><div class="detail-item-value">${escapeHtml(v.result || '')}</div></div>
              <div class="detail-item"><div class="detail-item-label">詳細</div><div class="detail-item-value">${escapeHtml(v.detail || '')}</div></div>
            </div>
          `;
        })
        .join('');
    }

    // 認証系エラー(ExpiredKeyMapError 等)で呼ばれる
    window.gm_authFailure = function () {
      const errBox = document.getElementById('mapError');
      if (errBox) errBox.style.display = 'block';
      console.error('Google Maps authentication failed (e.g., expired key).');
    };
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=marker&map_ids={{ map_id }}" async defer></script>
</body>
</html>
