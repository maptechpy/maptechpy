<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapTech</title>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:"Roboto", sans-serif; }
    #header {
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      padding:10px;
      position:fixed;
      top:0;
      width:100%;
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .header-title { font-size:18px; }
    #toggleHeader {
      background:none;
      border:none;
      font-size:16px;
      cursor:pointer;
    }
    #mapMenu {
      background:#fff;
      border-bottom:1px solid #dcdcdc;
      position:fixed;
      top:50px;
      left:0;
      width:100%;
      height:30px;
      overflow:hidden;
      transition:height 0.3s;
      z-index:999;
    }
    #mapMenu.expanded { height:150px; }
    #mapMenuHeader { display:flex; align-items:center; padding:0 10px; height:30px; cursor:pointer; }
    #mapMenuContent { display:none; padding:10px; }
    #mapMenu.expanded #mapMenuContent { display:block; }
    .menu-buttons { display:flex; flex-wrap:wrap; gap:10px; }
    .mapTButton { padding:5px 10px; background:#eee; border-radius:4px; text-decoration:none; color:#333; }
    #map {
      width:100%;
      height:calc(100% - 50px);
      margin-top:50px;
    }
  </style>
</head>
<body>
  <div id="header">
    <div class="header-title">MapTech 地図モバイル</div>
    <button id="toggleHeader">▲</button>
  </div>

  <div id="mapMenu" class="expanded">
    <div id="mapMenuHeader">
      <span id="hideLink">▼ メニュー</span>
      <span id="showLink" style="display:none;">▶ メニュー</span>
    </div>
    <div id="mapMenuContent">
      <div class="menu-buttons">
        <a href="#" class="mapTButton" onclick="openSetting()">ユーザ設定</a>
        <a href="#" class="mapTButton" onclick="searchRecords()">検索</a>
        <a href="#" class="mapTButton" onclick="showRoute()">ルート</a>
        <a href="#" class="mapTButton" onclick="registerLead()">登録モード</a>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const header = document.getElementById('header');
      const toggleBtn = document.getElementById('toggleHeader');
      const mapMenu = document.getElementById('mapMenu');
      const hideLink = document.getElementById('hideLink');
      const showLink = document.getElementById('showLink');

      toggleBtn.addEventListener('click', () => {
        if (header.style.display === 'none') {
          header.style.display = 'flex';
          toggleBtn.textContent = '▲';
          document.getElementById('map').style.marginTop = '50px';
        } else {
          header.style.display = 'none';
          toggleBtn.textContent = '▼';
          document.getElementById('map').style.marginTop = '0';
        }
      });

      hideLink.addEventListener('click', () => {
        mapMenu.classList.remove('expanded');
        hideLink.style.display = 'none';
        showLink.style.display = 'inline';
      });

      showLink.addEventListener('click', () => {
        mapMenu.classList.add('expanded');
        hideLink.style.display = 'inline';
        showLink.style.display = 'none';
      });
    });

    function initMap() {
      const defaultPos = { lat: 35.681236, lng: 139.767125 };
      const map = new google.maps.Map(document.getElementById('map'), {
        center: defaultPos,
        zoom: 13
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userPos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            new google.maps.Marker({ position: userPos, map: map, title: '現在地' });
            map.setCenter(userPos);
          },
          (error) => console.error('Geolocation error:', error)
        );
      }

      fetch('/api/markers')
        .then(res => res.json())
        .then(data => {
          data.forEach(m => {
            new google.maps.Marker({
              position: { lat: m.lat, lng: m.lng },
              map: map,
              title: m.title
            });
          });
        })
        .catch(err => console.error('Markers fetch error:', err));
    }

    function openSetting() { alert('設定画面を開きます'); }
    function searchRecords() { alert('検索機能を呼び出します'); }
    function showRoute() { alert('ルート表示を実行します'); }
    function registerLead() { alert('リード登録モードに切り替えます'); }
  </script>
</body>
</html>
